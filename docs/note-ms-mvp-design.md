# Note.ms 克隆版 MVP 设计文档

## 1. 文档信息

- 文档版本：v1.1
- 编写日期：2026-02-06
- 文档目标：定义 Note.ms 风格匿名笔记服务的可实现 MVP 方案，作为后续开发、测试与上线依据。

## 2. 背景与目标

### 2.1 背景

目标站点提供极简匿名在线笔记能力：通过 URL 路径定位笔记，进入页面即可编辑，系统自动保存。

### 2.2 产品目标

- 提供“URL 即笔记 ID”的匿名文本笔记能力。
- 提供“打开即编辑 + 自动保存 + 刷新可恢复”的核心体验。
- 在最小复杂度前提下保证稳定性与基本安全性。

### 2.3 非目标（MVP 不包含）

- 用户账号、登录、权限体系。
- 富文本/Markdown 渲染。
- 历史版本、回滚、只读分享链接。
- 端到端加密、访问密码能力。
- 多人实时协作。
- 搜索、分类、标签等知识管理能力。

## 3. 范围与边界

### 3.1 功能范围

- 根路径访问自动跳转至随机短 ID（如 `/ab12`）。
- 支持用户在地址栏手动输入 `/:id` 直接访问对应笔记。
- 访问 `/:id` 可读取对应笔记；不存在时返回空笔记并允许写入创建。
- 页面仅包含文本编辑区与最小状态提示。
- 编辑后自动保存（周期检查内容变更）。

### 3.2 合规边界

- 仅存储用户主动输入的文本。
- 不采集不必要个人信息。
- 不提供绕过安全策略的能力。

## 4. 用户流程

### 4.1 核心流程

1. 用户访问 `/`，或手动输入 `/:id`。
2. 若访问 `/`：服务端生成未占用随机 ID 并重定向到 `/:id`。
3. 若访问 `/:id`：按输入 ID 直接读取内容；不存在则返回空内容页。
4. 用户输入文本。
5. 前端每 1 秒检查文本变化；若变化则发起保存请求。
6. 保存成功后更新“已保存”状态；失败时显示“保存失败/重试中”。
7. 刷新页面后可重新看到最新内容。

### 4.2 页面状态

- 初始化：读取中。
- 就绪：可编辑。
- 保存中：提交请求中。
- 已保存：最新内容已落库。
- 失败：保存失败，待自动重试或下一次输入触发保存。

## 5. 架构设计

### 5.1 总体架构

- 前端：单页极简编辑界面（textarea + 状态提示）。
- 后端：提供按 noteId 读取与覆盖写入接口。
- 存储：关系型数据库单表（或 KV，MVP 默认关系型）。

### 5.2 组件职责

- Web 页面渲染层：输出基础 HTML 与初始内容。
- API 层：处理 `GET /:id` 与 `POST /:id`。
- 持久层：按 noteId upsert 文本内容与更新时间。
- 观测层：记录保存请求成功率、延迟、失败原因。

## 6. 数据模型

### 6.1 实体定义

`notes`

- `id`：字符串，主键（笔记 ID）。
- `content`：文本内容。
- `version`：版本号（用于后续并发控制，MVP 可先自增保留字段）。
- `created_at`：创建时间。
- `updated_at`：更新时间。

### 6.2 约束建议

- `id` 固定长度：4 字符，仅允许 `[a-z0-9]`。
- `content` 长度上限：建议 200KB（可配置）。

### 6.3 短链接空间与容量

- 字符集：`[a-z0-9]`，共 36 个字符。
- 固定长度：4。
- 总可用空间：`36^4 = 1,679,616`。
- 容量预警：当已使用 ID > 80%（1,343,692）时触发告警；> 95%（1,595,635）时限制新建并准备扩容策略（例如切换到 5 位 ID）。

## 7. 接口设计

### 7.1 `GET /`

- 行为：生成随机 noteId 并 302 跳转到 `/:id`。
- 约束：不得跳转到已存在笔记；必须分配“当前不存在”的新 ID。
- 响应：302 + `Location: /{noteId}`。

### 7.2 `GET /:id`

- 入参：路径参数 `id`。
- 行为：支持用户手动输入 URL 访问该 `id`；存在则读取内容，不存在则返回空内容页面（不在此阶段落库）。
- 校验：`id` 必须满足 4 位 `[a-z0-9]`，不合法返回 400。
- 响应：HTML（服务端注入初始内容）。

### 7.3 `POST /:id`

- 入参：路径参数 `id`。
- 请求头：`Content-Type: application/x-www-form-urlencoded`。
- 请求体：`t=<urlencoded content>`。
- 行为：若记录不存在则创建；存在则覆盖保存并更新时间。
- 响应：200（可空响应体）。

### 7.4 错误码建议

- 400：`id` 非法或参数缺失。
- 413：内容超过限制。
- 429：触发限流。
- 500：服务端异常。

## 8. 前端交互与状态机

### 8.1 自动保存策略

- 维护 `lastSavedContent` 与当前编辑值。
- 定时器周期：1000ms。
- 若内容有变化且当前无 in-flight 请求，则发起保存。
- 保存成功：更新 `lastSavedContent`。
- 保存失败：保留当前内容，进入失败态，并在后续输入或下一周期重试。

### 8.2 并发与覆盖策略

- MVP：最后写入覆盖（Last Write Wins）。

### 8.3 新 ID 分配策略（服务端）

- 入口：仅 `GET /` 执行新 ID 分配。
- 算法：随机生成 4 位 `[a-z0-9]` -> 查询是否存在 -> 不存在则返回。
- 重试：单次请求最多重试 8 次；若连续冲突则返回 503（`ID_POOL_BUSY`）。
- 原子性：通过数据库唯一键约束 + 插入保留记录（或等价原子操作）避免并发下分配同一 ID。

## 9. 非功能需求

### 9.1 性能

- 首屏（HTML）P95 < 1s。
- 保存请求 P95 < 200ms（同区域部署目标）。

### 9.2 可用性

- 保存失败可见且可恢复。
- 页面刷新不丢已成功保存内容。

### 9.3 安全

- 对 `id` 与内容做输入校验。
- 内容输出时进行 HTML 转义，防止 XSS。
- 限流防刷（按 IP + noteId）。

## 10. 监控与运维

### 10.1 指标

- 保存成功率。
- 保存失败率（按状态码分桶）。
- 保存延迟（P50/P95/P99）。
- 单 noteId 写入频率分布。

### 10.2 日志

- 请求日志：方法、路径、状态码、耗时。
- 错误日志：异常类型、堆栈、上下文 ID。

## 11. 测试与验收

### 11.1 功能测试

- 新 ID 打开为空内容。
- 输入后自动保存成功。
- 刷新后可读到最新内容。
- 非法 ID、超长内容、限流场景返回预期错误码。

### 11.2 回归测试

- 高频输入下不出现请求风暴。
- 网络抖动时失败提示与重试行为正确。
- 多标签页并发写入时行为符合“最后写入覆盖”预期。

### 11.3 最小验收标准（DoD）

- 核心流程可用且稳定（创建、编辑、保存、回读）。
- 基础安全与限流策略生效。
- 关键指标可观测。

## 12. 里程碑计划

### M1：核心能力打通

- 完成 `GET /`、`GET /:id`、`POST /:id`。
- 完成单页编辑与自动保存。

### M2：稳定性增强

- 加入失败状态提示与重试策略。
- 加入限流与输入边界校验。
- 补齐核心监控指标。

### M3：可扩展预留

- 当 ID 空间逼近阈值时，扩展到 5 位 ID 并平滑迁移。

## 13. 风险与应对

- 风险：匿名 URL 被猜测导致内容泄露。
- 应对：控制可预测性（高质量随机源）、限流与异常访问监控。
- 风险：并发覆盖造成内容丢失。
- 应对：MVP 明确策略；后续引入冲突检测。
- 风险：恶意高频写入造成资源压力。
- 应对：限流、黑名单、WAF/CDN 防护。
